<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    
    上邪</title>
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">
  
  <script src="/js/pace.min.js"></script>
  <!-- <script src="https://leancloud.cn/scripts/lib/av-0.4.6.min.js"></script>
  <script>AV.initialize("Cirh9OyzJLKMMq9RNThKaiAA-gzGzoHsz", "blnHQ35jvRhUS6eJMJmAT3Fc");</script> -->
</head>
</html>
<body>
<main class="content">
  <section class="outer">
  

<article id="post-Vue2.0和3.0数据响应原理" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>
  
  <div class="article-inner">
    

    
      <div class="article-meta">
        <a href="/2019/12/01/Vue2.0和3.0数据响应原理/" class="article-date">
  <time datetime="2019-12-01T03:15:04.045Z" itemprop="datePublished">2019-12-01</time>
</a>
        
      </div>
    

    
      
    <div class="tocbot"></div>





    

    <div class="article-entry" itemprop="articleBody">
      


      

      
        <h4 id="Vue2-0和3-0数据响应原理"><a href="#Vue2-0和3-0数据响应原理" class="headerlink" title="Vue2.0和3.0数据响应原理"></a>Vue2.0和3.0数据响应原理</h4><p>前两天跟着网易公开课学习了vue数据响应原理。</p>
<p>Vue2.0是利用了<strong>Object.defineProoerty()</strong>这个方法重新定义可对象属性获取值（get）和设置属性值（set）的操作来实现的。</p>
<p>3.0是采用es6的<strong>Proxy</strong>对象来实现的</p>
<a id="more"></a>
<p>下面分别实现一下，并记下自己粗浅的理解。</p>
<p>个人理解2.0版：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">		&lt;title&gt;&lt;/title&gt;</span><br><span class="line">	&lt;/head&gt;</span><br><span class="line">	&lt;body&gt;</span><br><span class="line">		&lt;div id=&quot;app&quot;&gt;</span><br><span class="line">			&lt;h1&gt;数据响应式&lt;/h1&gt;</span><br><span class="line">			&lt;div&gt;</span><br><span class="line">				&lt;div v-text=&quot;myText&quot;&gt;&lt;/div&gt;</span><br><span class="line">				&lt;div v-text=&quot;myBox&quot;&gt;&lt;/div&gt;</span><br><span class="line">				&lt;input type=&quot;text&quot; v-model=&quot;myText&quot;&gt;</span><br><span class="line">				&lt;input type=&quot;text&quot; v-model=&quot;myBox&quot;&gt;</span><br><span class="line">			&lt;/div&gt;</span><br><span class="line">		&lt;/div&gt;</span><br><span class="line">	&lt;/body&gt;</span><br><span class="line">	&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">	//1.首先实现整体架构（包括MVVM类或者VUE类，Watcher类），用到一个订阅者发布者设计模式</span><br><span class="line">	//2.然后实现MVVM中的由M到V，把模型里面的属性绑定到视图</span><br><span class="line">	//3.最后实现V-M，当文本框输入为文本的时候，由文本时间触发更新模型中的数据，同时更新相对应的视图</span><br><span class="line">	</span><br><span class="line">	//Vue实例化的时候获取到参数，并且劫持数据，解析指令</span><br><span class="line">		class Vue&#123;</span><br><span class="line">			constructor(options) &#123;</span><br><span class="line">			    this.options = options;</span><br><span class="line">				this.$data = options.data;</span><br><span class="line">				this.$el = document.querySelector(options.el);</span><br><span class="line">				this._directive = &#123;&#125;;  </span><br><span class="line">				this.Observer(this.$data);</span><br><span class="line">				this.Compile(this.$el);</span><br><span class="line">			&#125;</span><br><span class="line">			//劫持数据  拿到new Vue传递过来的data值，遍历key，value并且存放在——   //directive对象内,并且为每个key,value添加defineProperty的get和set方法 在这里面去判断，如果对象的value发生了改变，那么就调用update()更新视图上的数据 update是Watcher的实例化方法，这里之所以可以调用到，是因为解析指令时，给所有的相关指令的节点都实例化了Watcher </span><br><span class="line">			Observer(data)&#123;</span><br><span class="line">				console.log(&apos;劫持数据&apos;);</span><br><span class="line">				for(let key in data)&#123;</span><br><span class="line">					this._directive[key] = [];</span><br><span class="line">					let val = data[key];</span><br><span class="line">					let watch = this._directive[key];</span><br><span class="line">					Object.defineProperty(this.$data,key,&#123;</span><br><span class="line">						get: function()&#123;</span><br><span class="line">							return val;</span><br><span class="line">						&#125;,</span><br><span class="line">						set: function(newVal)&#123;</span><br><span class="line">							if(newVal !== val)&#123;</span><br><span class="line">								val = newVal;</span><br><span class="line">								watch.forEach(element=&gt;&#123;</span><br><span class="line">									element.update();</span><br><span class="line">								&#125;)</span><br><span class="line">							&#125;	</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			//解析指令 拿到绑定了指令的节点，并且为这些节点添加Watcher观察者。同时监听用户输入也就是视图层的数据改变，如果改变了，更改对应节点的value ，value的改变会触发相应watcher</span><br><span class="line">			Compile(el)&#123;</span><br><span class="line">				console.log(&apos;解析指令&apos;);</span><br><span class="line">				let nodes = el.children;//获取app下所有的子节点</span><br><span class="line">				for(let i = 0;i &lt; nodes.length; i++)&#123;</span><br><span class="line">					let node = nodes[i];</span><br><span class="line">					if(node.hasAttribute(&apos;v-text&apos;))&#123;</span><br><span class="line">						let attrVal = node.getAttribute(&apos;v-text&apos;);</span><br><span class="line">						this._directive[attrVal].push(new Watcher(node,this,attrVal,&apos;innerHTML&apos;));</span><br><span class="line">					&#125;</span><br><span class="line">					if(node.hasAttribute(&apos;v-model&apos;))&#123;</span><br><span class="line">						let attrVal = node.getAttribute(&apos;v-model&apos;,node);</span><br><span class="line">						this._directive[attrVal].push(new Watcher(node,this,attrVal,&apos;value&apos;));</span><br><span class="line">						node.addEventListener(&apos;input&apos;,() =&gt; &#123;</span><br><span class="line">							this.$data[attrVal] = node.value;</span><br><span class="line">							console.log(this.$data);</span><br><span class="line">						&#125;)</span><br><span class="line">					&#125;</span><br><span class="line">					//这里是一个递归解析，确保把所有的节点都解析到</span><br><span class="line">					if(node.children.length)&#123;</span><br><span class="line">						this.Compile(node);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">			//订阅者 接收传来的参数，更新视图</span><br><span class="line">		class Watcher&#123;</span><br><span class="line">			constructor(el,vm,exp,attr) &#123;</span><br><span class="line">				this.el = el;//元素对象 div input</span><br><span class="line">				this.vm = vm;</span><br><span class="line">				this.exp = exp;</span><br><span class="line">				this.attr = attr;</span><br><span class="line">				this.update();</span><br><span class="line">			&#125;</span><br><span class="line">			update()&#123;</span><br><span class="line">				console.log(&apos;订阅者&apos;);</span><br><span class="line">				this.el[this.attr] = this.vm.$data[this.exp];</span><br><span class="line">			&#125;	</span><br><span class="line">		&#125;</span><br><span class="line">		// new出来的Vue实例，传入app的html节点，和data数据</span><br><span class="line">		const app = new Vue(&#123;</span><br><span class="line">			el:&apos;#app&apos;,</span><br><span class="line">			data: &#123;</span><br><span class="line">				myText:&apos;大吉大利！今晚吃鸡&apos;,</span><br><span class="line">				myBox:&apos;我是一个盒子&apos;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;)</span><br><span class="line">	&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>Vue数据响应原理3.0 版</p>
<p>首先需要了解es6的Proxy</p>
<p><a href="http://caibaojian.com/es6/proxy.html" target="_blank" rel="noopener">官方文档</a>是这样描述的 Proxy用于修改某些操作的默认行为，等同于在语言层面作出修改，属于一种“元编程”，也就是对编程语言进行扩展。</p>
<p>可以这样理解，就是在目标对象外面架设了一层“拦截”或者“代理”，外界对该对象的访问，都必须通过这个代理。这个代理呢，负责对外界访问进行过滤和修改。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//Proxy例子</span><br><span class="line">var obj = new Proxy(&#123;&#125;, &#123;</span><br><span class="line">  get: function (target, key, receiver) &#123;</span><br><span class="line">    console.log(`getting $&#123;key&#125;!`);</span><br><span class="line">    return Reflect.get(target, key, receiver);</span><br><span class="line">  &#125;,</span><br><span class="line">  set: function (target, key, value, receiver) &#123;</span><br><span class="line">    console.log(`setting $&#123;key&#125;!`);</span><br><span class="line">    return Reflect.set(target, key, value, receiver);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">		&lt;title&gt;Vue3.0中的一大亮点Proxy的使用&lt;/title&gt;</span><br><span class="line">	&lt;/head&gt;</span><br><span class="line">	&lt;body&gt;</span><br><span class="line">		&lt;div id=&quot;app&quot;&gt;</span><br><span class="line">				&lt;h3 id=&quot;paragraph&quot;&gt;&lt;/h3&gt;</span><br><span class="line">				&lt;input type=&quot;text&quot; id=&quot;input&quot;&gt;</span><br><span class="line">		&lt;/div&gt;</span><br><span class="line">	&lt;/body&gt;</span><br><span class="line">	&lt;script&gt;</span><br><span class="line">			//获取段落的节点</span><br><span class="line">			const paragraph = document.getElementById(&apos;paragraph&apos;);</span><br><span class="line">			//获取输入框节点</span><br><span class="line">			const input = document.getElementById(&apos;input&apos;);</span><br><span class="line">			</span><br><span class="line">			//需要代理的数据对象</span><br><span class="line">			const data = &#123;</span><br><span class="line">				text:&apos;hello world&apos;</span><br><span class="line">			&#125;</span><br><span class="line">			const handler = &#123;</span><br><span class="line">				//监控data中的text属性变化</span><br><span class="line">				set: function(target,prop,value)&#123;</span><br><span class="line">					if(prop === &apos;text&apos;)&#123;</span><br><span class="line">						//更新值</span><br><span class="line">						target[prop] = value;</span><br><span class="line">						//更新视图</span><br><span class="line">						paragraph.innerHTML = value;</span><br><span class="line">						input.value = value;</span><br><span class="line">						return true;</span><br><span class="line">					&#125;else&#123;</span><br><span class="line">						return false;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			//构造proxy对象</span><br><span class="line">			const myText = new Proxy(data,handler);</span><br><span class="line">			</span><br><span class="line">			//添加input监听事件</span><br><span class="line">			input.addEventListener(&apos;input&apos;,function(e)&#123;</span><br><span class="line">				myText.text = e.target.value;//更新myText的值</span><br><span class="line">			&#125;,false)</span><br><span class="line">			</span><br><span class="line">			//初始化值</span><br><span class="line">			myText.text = data.text;</span><br><span class="line">			//上述我们通过Proxy创建了myText实例</span><br><span class="line">			//通过拦截myText中text属性set方法,来更新视图变化</span><br><span class="line">			//实现了一个极为简单的双向数据绑定</span><br><span class="line">			</span><br><span class="line">	&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/01/Vue2.0和3.0数据响应原理/" data-id="ck3mo8kx70000ox14q5pf479l"
         class="article-share-link">Share</a>
      
    </footer>

  </div>

  
    
  <nav class="article-nav">
    
      <a href="/2019/12/01/教你在家做大盘鸡/" class="article-nav-link">
        <strong class="article-nav-caption">Newer posts</strong>
        <div class="article-nav-title">
          
            (no title)
          
        </div>
      </a>
    
    
      <a href="/2019/11/26/误删stash的补救方案/" class="article-nav-link">
        <strong class="article-nav-caption">Olde posts</strong>
        <div class="article-nav-title"></div>
      </a>
    
  </nav>


  

  
    
  

</article>



</section>
  <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
    <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li class="">&copy; 2019 上邪</li>
    </ul>
  </div>
</footer>

</main>

<aside class="sidebar sidebar-specter">
  
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
    <div class="logo">
      <a href="/"><img src="/images/hexo.svg" alt="上邪"></a>
    </div>
  
  <ul class="nav nav-main">
    
      <li class="nav-item">
        <a class="nav-item-link" href="/">Home</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/archives">Archives</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/gallery">Gallery</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/about">About</a>
      </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="Search">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
        <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
          <i class="fe fe-feed"></i>
        </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/lazyload.min.js"></script>
<script src="/js/busuanzi-2.3.pure.min.js"></script>

  <script src="/fancybox/jquery.fancybox.min.js"></script>



  <script src="/js/tocbot.min.js"></script>
  <script>
    // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
    tocbot.init({
      tocSelector: '.tocbot',
      contentSelector: '.article-entry',
      headingSelector: 'h1, h2, h3, h4, h5, h6',
      hasInnerContainers: true,
      scrollSmooth: true,
      positionFixedSelector: '.tocbot',
      positionFixedClass: 'is-position-fixed',
      fixedSidebarOffset: 'auto',
    });
  </script>


<script src="/js/ocean.js"></script>
<!--
//page counter part
<script>
  function addCount (Counter) {
          url=$('.article-date').attr('href').trim();
      title = $('.article-title').text().trim();
      var query=new AV.Query(Counter);
      //use url as unique idnetfication
      query.equalTo("url",url);
      query.find({
          success: function(results){
              if(results.length>0)
              {
                  var counter=results[0];
                  counter.fetchWhenSave(true); //get recent result
                  counter.increment("time");
                  counter.save();
              }
              else
              {
                  var newcounter=new Counter();
                  newcounter.set("title",title);
                  newcounter.set("url",url);
                  newcounter.set("time",1);
                  newcounter.save(null,{
                      success: function(newcounter){
                         //alert('New object created');
                    },
                    error: function(newcounter,error){
                    alert('Failed to create');
                    }
                    });
            }
        },
        error: function(error){
            //find null is not a error
            alert('Error:'+error.code+" "+error.message);
        }
    });
}
$(function(){
    var Counter=AV.Object.extend("Counter");
    //only increse visit counting when intering a page
    if ($('.article-title').length == 1)
       addCount(Counter);
    var query=new AV.Query(Counter);
    query.descending("time");
    // the sum of popular posts
    query.limit(10); 
    query.find({
        success: function(results){
                for(var i=0;i<results.length;i++)    
                {
                    var counter=results[i];
                    title=counter.get("title");
                    url=counter.get("url");
                    time=counter.get("time");
                    // add to the popularlist widget
                    showcontent=title+" ("+time+")";
                    //notice the "" in href
                    $('.popularlist').append('<li><a href="'+url+'">'+showcontent+'</a></li>');
                }
            },
        error: function(error){
            alert("Error:"+error.code+" "+error.message);
        }
        }
    )
    });
-->

</body>
</html>